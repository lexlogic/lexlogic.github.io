<!doctype html><html lang=en><head><title>Logic | Sec</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keywords content="Newsroom"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="VAmPI the vulnerable API for security testing"><meta property="og:description" content="Well it was one of this times where in an attempt to &ldquo;fix a light bulb&rdquo; a series of events lead you to do something else first. For those who do not"><meta property="og:url" content="https://lexlogic.github.io/post/2022-10-02-training-api/"><meta property="og:image" content="https://lexlogic.github.io/images/banner.png"><link rel=canonical href=https://lexlogic.github.io/post/2022-10-02-training-api/><link rel="shortcut icon" type=image/png href=https://lexlogic.github.io/images/icons/favicon.png><link rel=manifest href=https://lexlogic.github.io/images/icons/site.webmanifest><link rel=stylesheet href=https://lexlogic.github.io/css/styles.02a27b11b708eaf0d4d62ac9947bab7494525b3f61a8686af59ec6e1998f8cb24d2319c527fcdcea12c62736f739bc2e90b185b7af4fa49b48805bc7d557caae.css integrity="sha512-AqJ7EbcI6vDU1irJlHurdJRSWz9hqGhq9Z7G4ZmPjLJNIxnFJ/zc6hLGJzb3ObwukLGFt69PpJtIgFvH1VfKrg=="><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenMax.min.js></script></head><body><div class=nav-drop><div class=nav-body><a href=https://lexlogic.github.io/about/ class=nav_item>About</a>
<a href=https://lexlogic.github.io class=nav_item>Blog</a>
<a href=https://lexlogic.github.io/categories class=nav_item>Category</a>
<a href=https://lexlogic.github.io/tags class=nav_item>Tag</a><div class=nav-close></div><div class=color_mode><label for=mode>Toggle Dark Mode</label>
<input type=checkbox class=color_choice id=mode></div></div></div><header class="nav d-block"><nav class=nav-menu><a href=https://lexlogic.github.io class="nav-brand nav_item"><img src=https://lexlogic.github.io/logo.png class=nav_logo></a><div></div></nav></header><main><div class="wrap mt"><div><p class=post_date>SECURITY | 02. October 2022</p><h1 class=post_title>VAmPI the vulnerable API for security testing</h1><div class=post_body><div class=post_inner><img src=images/banner.png alt=banner.png class=post_thumbnail><p>Well it was one of this times where in an attempt to &ldquo;fix a light bulb&rdquo; a series of events lead you to do something else first. For those who do not know what I am talking about, go ahead and spend 40 seconds to watch this video.</p><p>I was trying to assess how well certain tools perform on finding vulnerabilities in APIs. In order to do that, I required a vulnerable API that could cover vulnerabilities included in the OWASP top 10 for APIs and that it would be consistent in its responses across different endpoints. Also many of the testing tools, given that we are testing APIs, they require a Swagger or OpenAPI file to be available in order to determine the endpoints, parameters, responses etc.</p><p>Long story short I was not really happy with the google results and therefore I decided to make something myself. VAmPI is written in Python using Flask and Connexion.</p><p>You can find the project in my Github here along with some details about it and some instructions on how to run it. There is no need to write here as well the endpoints found in VAmPI, feel free to either check them on the Github page or to use the Swagger Editor page supplying it with the OpenAPI file found in the project.</p><p>In this article I am going to go into a bit more detail about the locations of the vulnerabilities found in the code.</p><p>SQL Injection</p><p>In order to have an SQLi it is required to be able to pass unsanitized data to a database query. To achieve this it was mandatory to pass a query directly to the database using the execute method of the session object of the SQLAlchemy. The vulnerable code is shown below and it can be found in the models/user_model.py file in the method get_user.</p><p>user_query = f"SELECT * FROM users WHERE username = &lsquo;{username}&rsquo;"
query = db.session.execute(user_query)
ret = query.fetchone()</p><p>Unauthorized Password Change</p><p>In this vulnerability it is possible for an attacker to update/change the password of another user as the &ldquo;developer&rdquo; got mistaken in the code and instead of validating against the username from the token, the name from the URL was used! The responsible code is the following and can be found in file api_views/users.py in the method update_password.</p><p>user = User.query.filter_by(username=username).first()
user.password = request_data.get(&lsquo;password&rsquo;)
db.session.commit()</p><p>Broken Object Level Authorization</p><p>In this case the developer forgot to include the username of the user requesting a book to the query made to the database. Therefore the book along with the secret are retrieved for any user as long as she/he has a valid Bearer token. The responsible code is found in file api_views/books.py in the method get_by_title. In the next block we see the two cases where only in the second one the filter includes the fact that the user needs to have this book requested in order to retrieve it.</p><p>Vulnerable Case
book = Book.query.filter_by(book_title=str(book)).first()</p><p>Proper Case
book = Book.query.filter_by(user=user, book_title=str(book)).first()</p><p>Mass Assignment</p><p>In this vulnerability the developer has left an &ldquo;open window&rdquo; for a normal user to be able to register as an admin simply by passing an extra parameter at the post body. The trick is that this extra parameter is NOT in the OpenAPI specification so the &ldquo;attacker&rdquo; should do some guessing to figure out if the endpoint accepts only the request body as defined by the specification. This is something more known as Mass Assignment where guessing object`s properties and exploring options in endpoints is involved. The responsible code can be found in file api_views/users.py in the method register_user.</p><p>Excessive Data Exposure</p><p>One of the most often scenarios is debug endpoints being left behind as developers tend to forget about them. Usually they are not in the specifications so this means that a bit of &ldquo;guessing&rdquo; is required as well but in this case I have included it in the specification so it is easier to be understood. For your tests you might want to remove it from there and check if it will be found. The responsible code if found in file api_views/users.py in the method debug.</p><p>User and Password Enumeration</p><p>Sometimes APIs might be &ldquo;talking&rdquo; too much and reveal more than they should. In this scenario when a user attempts to login the API will respond explicitly if the username or the password are wrong allowing username and password enumeration. A proper response should be the same regardless of whether the username or the password are wrong. The responsible code is in file api_views/users.py in method login_user.</p><p>RegexDOS (Denial of Service)</p><p>When a user who has logged in attempts to update her/his email address it is possible to cause a denial of service attack when providing a malformed long email. Although this vulnerability is not a common one amongst APIs I thought it would be a good addition since it involves providing a malformed email with many characters and there will be no response from the API. It seems interesting how each api security testing tool will handle this case. The code responsible for this is in the file api_views/users.py in method update_email. The regex is shown below.</p><p>match = re.search(
r"^(<a href=%5B-.%5Cw%5D*%5B0-9a-zA-Z%5D>0-9a-zA-Z</a><em>@{1}([0-9a-zA-Z][-\w]</em>[0-9a-zA-Z].)+[a-zA-Z]{2,9})$",
str(request_data.get(&rsquo;email&rsquo;)))</p><p>Lack of Resources & Rate Limiting</p><p>Finally a really common vulnerability is that there is no limitation to how many requests a single entity may perform towards an API. Limitation that we often see in the corresponding web parts are missing when we are talking directly to the APIs. An example combined attack would be to brute force the login given that we can enumerate users and then we have a clear indication when the password we provide is wrong. Given that we can try unlimited times without being interrupted brute forcing is a viable option. Further, when lacking enough resources an attacker might be able to cause a denial of service simply by spamming the API with hundreds or thousands requests per second.</p><p>Conclusion</p><p>I hope this will be useful to others as well and also feel free to share your ideas on other attacks that you might want to see included and are fit for an API. Apart from assessing how tools perform on finding the vulnerabilities, VAmPI could also be used for teaching purposes, especially given that the &ldquo;fixed&rdquo; code is provided as well. Simply look for the if vuln statement and you will find the not vulnerable code on the else of it. For any suggestions, questions and ideas please use the contact form.</p></div><div class="post_extra mb-2"><div class=copy data-before="Share Story" data-after="Link Copied"><svg class="icon"><use xlink:href="#copy"/></svg></div></div><div></div></div></div><a href=https://lexlogic.github.io class=post_nav><span class=post_next>The Latest<svg class="icon icon_scale"><use xlink:href="#double-arrow"/></svg></span></a></div></main><link rel=stylesheet href=https://lexlogic.github.io/css/styles.cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e.css integrity="sha512-z4PhNX7vuL3xVChQ1m2AB9Yg5AULVxXcg/SpIdNs6c5H0NE8XYXysP+DGNKHfuwvY7kxvUdBeoGlODJ6+SfaPg=="><script src=js/slideshow.js></script>
<script src=https://lexlogic.github.io/js/index.min.d7a417a6642ddd196cd0e08da02121b3257ed5ad37968a79d288bdf0320d6d871eb99a75faee804449e1b7f4d5b8fbb73a7b7a0ae1c31bf012ece86dcf294ac2.js></script><svg width="0" height="0" class="hidden"><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 699.428 699.428" id="copy"><path d="M502.714.0H240.428C194.178.0 153 42.425 153 87.429l-25.267.59c-46.228.0-84.019 41.834-84.019 86.838V612c0 45.004 41.179 87.428 87.429 87.428H459c46.249.0 87.428-42.424 87.428-87.428h21.857c46.25.0 87.429-42.424 87.429-87.428v-349.19L502.714.0zM459 655.715H131.143c-22.95.0-43.714-21.441-43.714-43.715V174.857c0-22.272 18.688-42.993 41.638-42.993l23.933-.721v393.429C153 569.576 194.178 612 240.428 612h262.286c0 22.273-20.765 43.715-43.714 43.715zm153-131.143c0 22.271-20.765 43.713-43.715 43.713H240.428c-22.95.0-43.714-21.441-43.714-43.713V87.429c0-22.272 20.764-43.714 43.714-43.714H459c-.351 50.337.0 87.975.0 87.975.0 45.419 40.872 86.882 87.428 86.882H612v306zm-65.572-349.715c-23.277.0-43.714-42.293-43.714-64.981V44.348L612 174.857h-65.572zm-43.714 131.537H306c-12.065.0-21.857 9.77-21.857 21.835s9.792 21.835 21.857 21.835h196.714c12.065.0 21.857-9.771 21.857-21.835.0-12.065-9.792-21.835-21.857-21.835zm0 109.176H306c-12.065.0-21.857 9.77-21.857 21.834.0 12.066 9.792 21.836 21.857 21.836h196.714c12.065.0 21.857-9.77 21.857-21.836.0-12.064-9.792-21.834-21.857-21.834z"/></symbol><symbol viewBox="0 0 53 42" xmlns="http://www.w3.org/2000/svg" id="double-arrow"><path d="M.595 39.653a1.318 1.318.0 010-1.864L16.55 21.833a1.318 1.318.0 000-1.863L.595 4.014a1.318 1.318.0 010-1.863L2.125.62a1.318 1.318.0 011.864.0l19.35 19.349a1.318 1.318.0 010 1.863l-19.35 19.35a1.318 1.318.0 01-1.863.0zm29 0a1.318 1.318.0 010-1.864L45.55 21.833a1.318 1.318.0 000-1.863L29.595 4.014a1.318 1.318.0 010-1.863l1.53-1.53a1.318 1.318.0 011.864.0l19.35 19.349a1.318 1.318.0 010 1.863l-19.35 19.35a1.318 1.318.0 01-1.863.0z"/></symbol></svg></body></html>